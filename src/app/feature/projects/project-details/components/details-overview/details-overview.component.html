<div class="tab-content">
    @if (project$ | async; as project) {
        <div class="page-container">
            <!-- LEFT: Content -->
            <section class="left-content">
                <div class="project-meta">
                    @if (project.courseName || project.assignmentName) {
                        <div class="project-origin">
                            <p class="project-origin__course">{{ project.courseName }}</p>
                            <p class="project-origin__assignment">{{ project.assignmentName }}</p>
                        </div>
                    }
                    <h2 class="project-title">
                        {{ project.title || "Untitled Project" }}
                        @if (project.createdBy) {
                            <span class="creator-name">
                (Created by {{ project.createdBy.firstName }} {{ project.createdBy.lastName }})
              </span>
                        }
                    </h2>

                    @if ((canManageProject$ | async)) {
                        <div class="status-inline">
                            <app-statuscard [status]="project.status"></app-statuscard>
                        </div>
                    }
                </div>

                <div class="rich-content" [innerHTML]="project.description"></div>
            </section>

            <!-- RIGHT: Minimal sidebar -->
            <aside class="right-sidebar">
                @if ((isTeacher$ | async)) {
                    <section class="section">
                        <h3 class="section-label">UPDATE STATUS</h3>
                        <div class="section-body">
                            <app-project-status-select
                                [value]="project.status"
                                (valueChange)="updateProjectStatus(project, $event)">
                            </app-project-status-select>
                        </div>
                    </section>
                }

                @if (!(isResearcher$ | async) && !(canManageProject$ | async) && !(isMember$ | async)) {
                    <section class="section">
                        <h3 class="section-label">
                            @if (project.members.length === 0 && project.assignmentId != null) { CLAIM PROJECT }
                            @else if (project.members.length > 0 && project.assignmentId != null) { APPLY }
                            @else { IMPORT PROJECT }
                        </h3>
                        <div class="section-body">
                            @if (!(isResearcher$ | async) && project.members.length === 0 && project.assignmentId != null) {
                                <p class="muted">Press to claim this project. Youâ€™ll become its product owner.</p>
                                <app-button variant="primary" (click)="claimProject()">Claim Project</app-button>
                            }
                            @if (!(isResearcher$ | async) && project.members.length > 0 && project.assignmentId != null) {
                                <p class="muted">Apply to join and collaborate with this team.</p>
                                <app-button variant="primary" (click)="applyForProject()">Apply for this project</app-button>
                            }
                            @if (!(isResearcher$ | async) && project.assignmentId == null) {
                                <p class="muted">Import this global project into your current assignment.</p>
                                <app-button variant="primary" (click)="importProject()">Import Project</app-button>
                            }
                        </div>
                    </section>
                }

                <section class="section">
                    <h3 class="section-label">
                        MEMBERS <span class="section-count">{{ project.members.length || 0 }}/{{ project.teamSize }}</span>
                    </h3>
                    <ul class="members">
                        @if (project.productOwner) {
                            <li class="member member--owner">
                                <img class="avatar" [src]="project.productOwner.profileImageUrl" alt="Product owner avatar"/>
                                <span class="name">
                  {{ project.productOwner.firstName }} {{ project.productOwner.lastName }}
                                    <span class="badge badge--po">PO</span>
                </span>
                            </li>
                        } @else {
                            <li class="member member--empty">No product owner</li>
                        }
                        @for (member of getFilteredMembers(project.members || [], project.productOwner); track member) {
                            <li class="member">
                                <img class="avatar" [src]="member?.profileImageUrl" alt="Member avatar"/>
                                <span class="name">{{ member?.firstName || "" }} {{ member?.lastName || "" }}</span>
                            </li>
                        }
                    </ul>
                </section>

                <section class="section" *ngIf="(isMember$ | async)">
                    <h3 class="section-label">ACTIONS</h3>
                    <div class="section-body">
                        <app-button variant="danger" (click)="openLeaveModal()">
                            Leave Project
                        </app-button>
                    </div>
                </section>

                <section class="section" *ngIf="repositoryUrl || boardUrl">
                    <h3 class="section-label">LINKS</h3>
                    <div class="section-body links">
                        @if (repositoryUrl) {
                            <app-linkcard [url]="repositoryUrl" variant="Repository"></app-linkcard>
                        }
                        @if (boardUrl) {
                            <app-linkcard [url]="boardUrl" variant="Board"></app-linkcard>
                        }
                    </div>
                </section>

                <section class="section" *ngIf="(tags?.length || 0) > 0">
                    <h3 class="section-label">TAGS</h3>
                    <div class="section-body tags">
                        @for (tag of tags; track tag) {
                            <app-tagcard [tag]="tag" [showDelete]="false"></app-tagcard>
                        }
                    </div>
                </section>
            </aside>
        </div>
    }
</div>

@if (showLeaveModal) {
    <app-confirmation-modal
        [title]="'Leave Project'"
        [message]="'Are you sure you want to leave this project?'"
        [confirmText]="'Leave'"
        [cancelText]="'Cancel'"
        (confirm)="confirmLeave()"
        (cancel)="closeLeaveModal()">
    </app-confirmation-modal>
}
